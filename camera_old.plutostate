Œ±cell_dependencies„Ù$b395e806-e51e-11ea-12f1-7f05ee45cbbd„´precedence_heuristic§cell_idÙ$b395e806-e51e-11ea-12f1-7f05ee45cbbd´downstream_cells_map·process_raw_camera_data²upstream_cells_map†¥UInt8¡:£RGB§reshape¡/£endÙ$1feb465a-e51e-11ea-3bca-8b7634072120„´precedence_heuristic§cell_idÙ$1feb465a-e51e-11ea-3bca-8b7634072120´downstream_cells_map¡i‘Ù$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb²upstream_cells_mapˆ¤Core¤Base«PlutoRunner°PlutoRunner.Bond¬camera_input‘Ù$762e167e-e51d-11ea-0721-e566ca397423¯Core.applicable¥@bind¨Base.getÙ$762e167e-e51d-11ea-0721-e566ca397423„´precedence_heuristic§cell_idÙ$762e167e-e51d-11ea-0721-e566ca397423´downstream_cells_map¬camera_input‘Ù$1feb465a-e51e-11ea-3bca-8b7634072120²upstream_cells_map‚¤HTML¢|>Ù$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb„´precedence_heuristic§cell_idÙ$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb´downstream_cells_map€²upstream_cells_map¡i‘Ù$1feb465a-e51e-11ea-3bca-8b7634072120´cell_execution_order”Ù$762e167e-e51d-11ea-0721-e566ca397423Ù$1feb465a-e51e-11ea-3bca-8b7634072120Ù$60d58bd8-e51e-11ea-328c-29f3c0d3d6bbÙ$b395e806-e51e-11ea-12f1-7f05ee45cbbd®process_status¥ready¤pathÙC/home/runner/work/disorganised-mess/disorganised-mess/camera_old.jlªcell_order”Ù$60d58bd8-e51e-11ea-328c-29f3c0d3d6bbÙ$1feb465a-e51e-11ea-3bca-8b7634072120Ù$762e167e-e51d-11ea-0721-e566ca397423Ù$b395e806-e51e-11ea-12f1-7f05ee45cbbd¥nbpkg„²installed_versions€§enabledÃ·restart_recommended_msgÀ´restart_required_msgÀ«cell_inputs„Ù$b395e806-e51e-11ea-12f1-7f05ee45cbbdƒ§cell_idÙ$b395e806-e51e-11ea-12f1-7f05ee45cbbd¤codeÚ¨function process_raw_camera_data(raw_camera_data)
	# the raw image data is a long byte array, we need to transform it into something
	# more "Julian" - something with more _structure_.
	
	# The encoding of the raw byte stream is:
	# every 4 bytes is a single pixel
	# every pixel has 4 values: Red, Green, Blue, Alpha
	# (we ignore alpha for this notebook)
	
	# So to get the red values for each pixel, we take every 4th value, starting at 
	# the 1st:
	reds_flat = UInt8.(raw_camera_data["data"][1:4:end])
	greens_flat = UInt8.(raw_camera_data["data"][2:4:end])
	blues_flat = UInt8.(raw_camera_data["data"][3:4:end])
	
	# but these are still 1-dimensional arrays, nicknamed 'flat' arrays
	# We will 'reshape' this into 2D arrays:
	
	width = raw_camera_data["width"]
	height = raw_camera_data["height"]
	
	# shuffle and flip to get it in the right shape
	reds = reshape(reds_flat, (width, height))' / 255.0
	greens = reshape(greens_flat, (width, height))' / 255.0
	blues = reshape(blues_flat, (width, height))' / 255.0
	
	# we have our 2D array for each color
	# Let's create a single 2D array, where each value contains the R, G and B value of 
	# that pixel
	
	RGB.(reds, greens, blues)
end«code_foldedÂÙ$1feb465a-e51e-11ea-3bca-8b7634072120ƒ§cell_idÙ$1feb465a-e51e-11ea-3bca-8b7634072120¤code¶@bind i camera_input()«code_foldedÂÙ$762e167e-e51d-11ea-0721-e566ca397423ƒ§cell_idÙ$762e167e-e51d-11ea-0721-e566ca397423¤codeÚ>function camera_input(;maxsize=200, default_url="https://i.imgur.com/VGPeJ6s.jpg")
"""
<span class="pl-image waiting-for-permission">
<style>
	
	.pl-image.popped-out {
		position: fixed;
		top: 0;
		right: 0;
		z-index: 5;
	}

	.pl-image #video-container {
		width: 250px;
	}

	.pl-image video {
		border-radius: 1rem 1rem 0 0;
	}
	.pl-image.waiting-for-permission #video-container {
		display: none;
	}
	.pl-image #prompt {
		display: none;
	}
	.pl-image.waiting-for-permission #prompt {
		width: 250px;
		height: 200px;
		display: grid;
		place-items: center;
		font-family: monospace;
		font-weight: bold;
		text-decoration: underline;
		cursor: pointer;
		border: 5px dashed rgba(0,0,0,.5);
	}

	.pl-image video {
		display: block;
	}
	.pl-image .bar {
		width: inherit;
		display: flex;
		z-index: 6;
	}
	.pl-image .bar#top {
		position: absolute;
		flex-direction: column;
	}
	
	.pl-image .bar#bottom {
		background: black;
		border-radius: 0 0 1rem 1rem;
	}
	.pl-image .bar button {
		flex: 0 0 auto;
		background: rgba(255,255,255,.8);
		border: none;
		width: 2rem;
		height: 2rem;
		border-radius: 100%;
		cursor: pointer;
		z-index: 7;
	}
	.pl-image .bar button#shutter {
		width: 3rem;
		height: 3rem;
		margin: -1.5rem auto .2rem auto;
	}

	.pl-image video.takepicture {
		animation: pictureflash 200ms linear;
	}

	@keyframes pictureflash {
		0% {
			filter: grayscale(1.0) contrast(2.0);
		}

		100% {
			filter: grayscale(0.0) contrast(1.0);
		}
	}
</style>

	<div id="video-container">
		<div id="top" class="bar">
			<button id="stop" title="Stop video">âœ–</button>
			<button id="pop-out" title="Pop out/pop in">â</button>
		</div>
		<video playsinline autoplay></video>
		<div id="bottom" class="bar">
		<button id="shutter" title="Click to take a picture">ğŸ“·</button>
		</div>
	</div>
		
	<div id="prompt">
		<span>
		Enable webcam
		</span>
	</div>

<script>
	// based on https://github.com/fonsp/printi-static (by the same author)

	const span = this.currentScript.parentElement
	const video = span.querySelector("video")
	const popout = span.querySelector("button#pop-out")
	const stop = span.querySelector("button#stop")
	const shutter = span.querySelector("button#shutter")
	const prompt = span.querySelector(".pl-image #prompt")

	const maxsize = $(maxsize)

	const send_source = (source, src_width, src_height) => {
		const scale = Math.min(1.0, maxsize / src_width, maxsize / src_height)

		const width = Math.floor(src_width * scale)
		const height = Math.floor(src_height * scale)

		const canvas = html`<canvas width=\${width} height=\${height}>`
		const ctx = canvas.getContext("2d")
		ctx.drawImage(source, 0, 0, width, height)

		span.value = {
			width: width,
			height: height,
			data: ctx.getImageData(0, 0, width, height).data,
		}
		span.dispatchEvent(new CustomEvent("input"))
	}
	
	const clear_camera = () => {
		window.stream.getTracks().forEach(s => s.stop());
		video.srcObject = null;

		span.classList.add("waiting-for-permission");
	}

	prompt.onclick = () => {
		navigator.mediaDevices.getUserMedia({
			audio: false,
			video: {
				facingMode: "environment",
			},
		}).then(function(stream) {

			stream.onend = console.log

			window.stream = stream
			video.srcObject = stream
			window.cameraConnected = true
			video.controls = false
			video.play()
			video.controls = false

			span.classList.remove("waiting-for-permission");

		}).catch(function(error) {
			console.log(error)
		});
	}
	stop.onclick = () => {
		clear_camera()
	}
	popout.onclick = () => {
		span.classList.toggle("popped-out")
	}

	shutter.onclick = () => {
		const cl = video.classList
		cl.remove("takepicture")
		void video.offsetHeight
		cl.add("takepicture")
		video.play()
		video.controls = false
		console.log(video)
		send_source(video, video.videoWidth, video.videoHeight)
	}
	
	
	document.addEventListener("visibilitychange", () => {
		if (document.visibilityState != "visible") {
			clear_camera()
		}
	})


	// Set a default image

	const img = html`<img crossOrigin="anonymous">`

	img.onload = () => {
		send_source(img, img.width, img.height)
	}
	img.src = "$(default_url)"

</script>
</span>
""" |> HTML
end«code_foldedÂÙ$60d58bd8-e51e-11ea-328c-29f3c0d3d6bbƒ§cell_idÙ$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb¤code¡i«code_foldedÂ«notebook_idÙ$4e2a44a2-a699-11eb-053e-a538db73494d¥bonds€¬cell_results„Ù$b395e806-e51e-11ea-12f1-7f05ee45cbbd†¦queuedÂ§runningÂ¦output…¤bodyÙ8process_raw_camera_data (generic function with 1 method)°persist_js_stateÂ¤mimeªtext/plain²last_run_timestampËAØ!²ˆ‡‚ù¬rootassigneeÀ§cell_idÙ$b395e806-e51e-11ea-12f1-7f05ee45cbbd§runtimeÍ¶l§erroredÂÙ$1feb465a-e51e-11ea-3bca-8b7634072120†¦queuedÂ§runningÂ¦output…¤bodyÚõ<bond def="i"><span class="pl-image waiting-for-permission">
<style>
	
	.pl-image.popped-out {
		position: fixed;
		top: 0;
		right: 0;
		z-index: 5;
	}

	.pl-image #video-container {
		width: 250px;
	}

	.pl-image video {
		border-radius: 1rem 1rem 0 0;
	}
	.pl-image.waiting-for-permission #video-container {
		display: none;
	}
	.pl-image #prompt {
		display: none;
	}
	.pl-image.waiting-for-permission #prompt {
		width: 250px;
		height: 200px;
		display: grid;
		place-items: center;
		font-family: monospace;
		font-weight: bold;
		text-decoration: underline;
		cursor: pointer;
		border: 5px dashed rgba(0,0,0,.5);
	}

	.pl-image video {
		display: block;
	}
	.pl-image .bar {
		width: inherit;
		display: flex;
		z-index: 6;
	}
	.pl-image .bar#top {
		position: absolute;
		flex-direction: column;
	}
	
	.pl-image .bar#bottom {
		background: black;
		border-radius: 0 0 1rem 1rem;
	}
	.pl-image .bar button {
		flex: 0 0 auto;
		background: rgba(255,255,255,.8);
		border: none;
		width: 2rem;
		height: 2rem;
		border-radius: 100%;
		cursor: pointer;
		z-index: 7;
	}
	.pl-image .bar button#shutter {
		width: 3rem;
		height: 3rem;
		margin: -1.5rem auto .2rem auto;
	}

	.pl-image video.takepicture {
		animation: pictureflash 200ms linear;
	}

	@keyframes pictureflash {
		0% {
			filter: grayscale(1.0) contrast(2.0);
		}

		100% {
			filter: grayscale(0.0) contrast(1.0);
		}
	}
</style>

	<div id="video-container">
		<div id="top" class="bar">
			<button id="stop" title="Stop video">âœ–</button>
			<button id="pop-out" title="Pop out/pop in">â</button>
		</div>
		<video playsinline autoplay></video>
		<div id="bottom" class="bar">
		<button id="shutter" title="Click to take a picture">ğŸ“·</button>
		</div>
	</div>
		
	<div id="prompt">
		<span>
		Enable webcam
		</span>
	</div>

<script>
	// based on https://github.com/fonsp/printi-static (by the same author)

	const span = this.currentScript.parentElement
	const video = span.querySelector("video")
	const popout = span.querySelector("button#pop-out")
	const stop = span.querySelector("button#stop")
	const shutter = span.querySelector("button#shutter")
	const prompt = span.querySelector(".pl-image #prompt")

	const maxsize = 200

	const send_source = (source, src_width, src_height) => {
		const scale = Math.min(1.0, maxsize / src_width, maxsize / src_height)

		const width = Math.floor(src_width * scale)
		const height = Math.floor(src_height * scale)

		const canvas = html`<canvas width=${width} height=${height}>`
		const ctx = canvas.getContext("2d")
		ctx.drawImage(source, 0, 0, width, height)

		span.value = {
			width: width,
			height: height,
			data: ctx.getImageData(0, 0, width, height).data,
		}
		span.dispatchEvent(new CustomEvent("input"))
	}
	
	const clear_camera = () => {
		window.stream.getTracks().forEach(s => s.stop());
		video.srcObject = null;

		span.classList.add("waiting-for-permission");
	}

	prompt.onclick = () => {
		navigator.mediaDevices.getUserMedia({
			audio: false,
			video: {
				facingMode: "environment",
			},
		}).then(function(stream) {

			stream.onend = console.log

			window.stream = stream
			video.srcObject = stream
			window.cameraConnected = true
			video.controls = false
			video.play()
			video.controls = false

			span.classList.remove("waiting-for-permission");

		}).catch(function(error) {
			console.log(error)
		});
	}
	stop.onclick = () => {
		clear_camera()
	}
	popout.onclick = () => {
		span.classList.toggle("popped-out")
	}

	shutter.onclick = () => {
		const cl = video.classList
		cl.remove("takepicture")
		void video.offsetHeight
		cl.add("takepicture")
		video.play()
		video.controls = false
		console.log(video)
		send_source(video, video.videoWidth, video.videoHeight)
	}
	
	
	document.addEventListener("visibilitychange", () => {
		if (document.visibilityState != "visible") {
			clear_camera()
		}
	})


	// Set a default image

	const img = html`<img crossOrigin="anonymous">`

	img.onload = () => {
		send_source(img, img.width, img.height)
	}
	img.src = "https://i.imgur.com/VGPeJ6s.jpg"

</script>
</span>
</bond>°persist_js_stateÂ¤mime©text/html²last_run_timestampËAØ!²ˆRÍK¬rootassigneeÀ§cell_idÙ$1feb465a-e51e-11ea-3bca-8b7634072120§runtimeÎA!Ü§erroredÂÙ$762e167e-e51d-11ea-0721-e566ca397423†¦queuedÂ§runningÂ¦output…¤bodyÙ-camera_input (generic function with 1 method)°persist_js_stateÂ¤mimeªtext/plain²last_run_timestampËAØ!²ˆA–t¬rootassigneeÀ§cell_idÙ$762e167e-e51d-11ea-0721-e566ca397423§runtimeÍæx§erroredÂÙ$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb†¦queuedÂ§runningÂ¦output…¤body§missing°persist_js_stateÂ¤mimeªtext/plain²last_run_timestampËAØ!²ˆÕş¬rootassigneeÀ§cell_idÙ$60d58bd8-e51e-11ea-328c-29f3c0d3d6bb§runtimeÌÈ§erroredÂ©shortpath­camera_old.jl«in_temp_dirÂ